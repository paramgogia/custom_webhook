<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Webhook Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#111827',
                        darkCard: '#1f2937',
                        darkBorder: '#374151'
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-darkBg dark:text-gray-100 h-screen flex flex-col font-sans transition-colors duration-200">

    <header class="bg-white dark:bg-darkCard border-b border-gray-200 dark:border-darkBorder p-4 flex justify-between items-center shrink-0">
        <h1 class="text-xl font-bold tracking-tight">Webhook Catcher</h1>
        
        <div class="flex items-center space-x-4">
            <div class="flex items-center bg-gray-100 dark:bg-gray-800 rounded px-3 py-1.5 border border-gray-300 dark:border-gray-600">
                <span class="text-xs text-gray-500 dark:text-gray-400 mr-2 uppercase font-bold tracking-wider">Your URL</span>
                <input type="text" id="webhook-url" readonly class="bg-transparent border-none outline-none text-sm font-mono w-72 text-gray-800 dark:text-gray-200" value="Generating...">
                <button onclick="copyUrl()" class="ml-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 text-sm font-medium">Copy</button>
            </div>

            <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="Toggle Dark Mode">
                <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <aside class="w-1/3 max-w-sm border-r border-gray-200 dark:border-darkBorder bg-white dark:bg-darkCard flex flex-col">
            <div class="p-4 border-b border-gray-200 dark:border-darkBorder bg-gray-50 dark:bg-gray-800 shrink-0">
                <h2 class="text-sm font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">Incoming Requests</h2>
            </div>
            <div id="request-list" class="flex-1 overflow-y-auto divide-y divide-gray-100 dark:divide-gray-800">
                <div class="p-8 text-center text-gray-400 dark:text-gray-500 text-sm italic" id="empty-state">
                    Waiting for first request...
                </div>
            </div>
        </aside>

        <section class="flex-1 overflow-y-auto p-6 bg-gray-50 dark:bg-darkBg relative" id="detail-view">
            <div class="flex h-full items-center justify-center text-gray-400 dark:text-gray-500" id="detail-empty">
                Select a request from the sidebar to view details.
            </div>
            
            <div id="detail-content" class="hidden max-w-4xl mx-auto space-y-6 pb-12">
                <div class="flex items-center space-x-4 border-b border-gray-200 dark:border-darkBorder pb-4">
                    <span id="detail-method" class="px-3 py-1 rounded text-sm font-bold text-white uppercase tracking-wider">METHOD</span>
                    <span id="detail-time" class="text-gray-500 dark:text-gray-400 text-sm font-mono">Timestamp</span>
                    <span class="text-xs text-gray-400">ID: <span id="detail-id" class="font-mono"></span></span>
                </div>

                <div>
                    <h3 class="text-sm font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2">Query Parameters</h3>
                    <pre id="detail-query" class="bg-white dark:bg-darkCard border border-gray-200 dark:border-darkBorder p-4 rounded-lg text-sm font-mono overflow-x-auto text-gray-800 dark:text-gray-200 shadow-sm max-h-60 overflow-y-auto"></pre>
                </div>

                <div>
                    <h3 class="text-sm font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2">Headers</h3>
                    <pre id="detail-headers" class="bg-white dark:bg-darkCard border border-gray-200 dark:border-darkBorder p-4 rounded-lg text-sm font-mono overflow-x-auto text-gray-800 dark:text-gray-200 shadow-sm max-h-60 overflow-y-auto"></pre>
                </div>

                <div>
                    <h3 class="text-sm font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2">Raw Body</h3>
                    <pre id="detail-body" class="bg-gray-900 dark:bg-black border border-gray-800 p-4 rounded-lg text-sm font-mono overflow-x-auto text-green-400 shadow-sm max-h-96 overflow-y-auto"></pre>
                </div>
            </div>
        </section>

    </main>

    <script>
        const socket = io();
        let currentHookId = '';
        let requests = []; // Store all requests in memory
        let selectedId = null;

        // Theme Setup
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // Load saved theme
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        // Initialize: Get URL and join room
        async function init() {
            const res = await fetch('/api/new');
            const data = await res.json();
            currentHookId = data.id;
            document.getElementById('webhook-url').value = data.url;
            socket.emit('join_room', currentHookId);
        }

        // Listen for new webhooks
        socket.on('webhook_received', (payload) => {
            document.getElementById('empty-state')?.remove();
            
            // Add to our array
            requests.unshift(payload);
            
            // Render the sidebar item
            renderSidebarItem(payload);

            // Automatically select the first request if nothing is selected
            if (!selectedId) {
                selectRequest(payload.id);
            }
        });

        // Helper: Format JSON safely
        function formatJSON(data) {
            if (!data || Object.keys(data).length === 0) return 'No data';
            return JSON.stringify(data, null, 2);
        }

        // Helper: Determine color based on HTTP method
        function getMethodColor(method) {
            const m = method.toUpperCase();
            if (m === 'GET') return 'bg-blue-500';
            if (m === 'POST') return 'bg-green-500';
            if (m === 'PUT' || m === 'PATCH') return 'bg-yellow-500';
            if (m === 'DELETE') return 'bg-red-500';
            return 'bg-gray-500';
        }

        // Build a sidebar list item
        function renderSidebarItem(payload) {
            const list = document.getElementById('request-list');
            const time = new Date(payload.timestamp).toLocaleTimeString();
            
            const div = document.createElement('div');
            div.id = `req-${payload.id}`;
            div.className = `p-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-l-4 border-transparent`;
            div.onclick = () => selectRequest(payload.id);
            
            div.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs font-bold px-2 py-0.5 rounded text-white ${getMethodColor(payload.method)}">${payload.method}</span>
                    <span class="text-xs text-gray-500 dark:text-gray-400 font-mono">${time}</span>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-300 truncate font-mono mt-2">
                    ${payload.headers['user-agent'] || 'Unknown Sender'}
                </div>
            `;
            
            list.insertBefore(div, list.firstChild);
        }

        // View the details of a specific request
        function selectRequest(id) {
            selectedId = id;
            const payload = requests.find(r => r.id === id);
            if (!payload) return;

            // Highlight selected item in sidebar
            document.querySelectorAll('#request-list > div').forEach(el => {
                el.classList.remove('bg-blue-50', 'dark:bg-gray-800', 'border-blue-500');
                el.classList.add('border-transparent');
            });
            const selectedEl = document.getElementById(`req-${id}`);
            if (selectedEl) {
                selectedEl.classList.remove('border-transparent');
                selectedEl.classList.add('bg-blue-50', 'dark:bg-gray-800', 'border-blue-500');
            }

            // Show content area
            document.getElementById('detail-empty').classList.add('hidden');
            document.getElementById('detail-content').classList.remove('hidden');

            // Populate data
            const methodBadge = document.getElementById('detail-method');
            methodBadge.textContent = payload.method;
            methodBadge.className = `px-3 py-1 rounded text-sm font-bold text-white uppercase tracking-wider ${getMethodColor(payload.method)}`;
            
            document.getElementById('detail-time').textContent = new Date(payload.timestamp).toLocaleString();
            document.getElementById('detail-id').textContent = payload.id;
            
            document.getElementById('detail-query').textContent = formatJSON(payload.query);
            document.getElementById('detail-headers').textContent = formatJSON(payload.headers);
            
            // Handle body formatting (JSON vs Text)
            let bodyText = payload.body;
            if (typeof bodyText === 'object') {
                bodyText = formatJSON(bodyText);
            } else if (bodyText === '') {
                bodyText = 'No body content';
            }
            document.getElementById('detail-body').textContent = bodyText;
        }

        // Copy URL
        function copyUrl() {
            const urlInput = document.getElementById('webhook-url');
            urlInput.select();
            document.execCommand('copy');
            alert('Webhook URL copied to clipboard!');
        }

        // Start
        init();
    </script>
</body>
</html>